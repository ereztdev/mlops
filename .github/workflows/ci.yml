name: CI Pipeline

# This workflow runs on every push to main branch and on pull requests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Lint and Test
  # This job validates code quality and runs tests
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the code from the repository
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # Cache pip dependencies for faster builds
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Run code linting with flake8
    # This checks for code style and potential errors
    - name: Run linting (flake8)
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    # Run tests with pytest
    # This validates that all functionality works correctly
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src --cov-report=term-missing
    
    # Optional: Run type checking with mypy
    # Uncomment if you want strict type checking
    # - name: Run type checking (mypy)
    #   run: |
    #     mypy src/ --ignore-missing-imports

  # Job 2: Training
  # This job trains the model to ensure training pipeline works
  train-model:
    name: Train Model
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # Cache pip dependencies
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Run training script
    # This ensures the training pipeline works and produces model artifacts
    - name: Train model
      run: |
        python src/training/train.py
    
    # Upload model artifacts
    # This saves the trained model files so they can be downloaded later
    # Artifacts are stored for 90 days by default
    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: |
          models/*.pkl
        retention-days: 7
        if-no-files-found: warn

